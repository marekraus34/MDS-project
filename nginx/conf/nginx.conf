# nginx.conf pro MDS projekt
# Upraveno pro podporu multiple RTMP streams + HLS adaptivní streaming

error_log  logs/error.log info;
daemon off;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    server {
        listen 8081;
        listen 443 ssl;

        ssl_certificate ssl/cert.pem;
        ssl_certificate_key ssl/key.pem;

        root site;
        server_name localhost;
        
        access_log logs/access.log;
        error_log logs/error.log;

        index index.html;

        # Hlavní stránka
        location / {
            try_files $uri $uri/ /index.html;
        }

        # HLS streamy
        location /hls {
            alias temp/tmp_hls;

            # CORS headers pro HLS
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, OPTIONS';
            add_header Access-Control-Allow-Headers 'Range';

            # MIME types pro HLS
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }

            # DVR - umožní přístup k historii
            # Nginx automaticky cachuje segmenty
        }

        # Nahrávky (pokud budete ukládat)
        location /recordings {
            autoindex on;
            alias recordings;
        }

        # RTMP statistiky
        location /stats {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
            
            # Auto-refresh každé 3 sekundy
            add_header Refresh "3; $request_uri";
        }

        # API endpoint pro seznam aktivních kamer
        location /api/cameras {
            # Bude generován z /stats
            proxy_pass http://localhost:8081/stats;
        }
    }
}

# RTMP server konfigurace
rtmp {
    server {
        listen 1936;
        chunk_size 4096;
        ping 30s;
        ping_timeout 10s;

        # Aplikace pro jednotlivé kamery (cam1-cam6)
        application live {
            live on;
            
            # Povolíme publikování
            allow publish all;
            
            # DVR - ukládání posledních 20 minut
            record all;
            record_path recordings;
            record_max_size 500M;
            record_unique on;
            
            # HLS output - pro každou kameru zvlášť
            # (Optional - pro debugging jednotlivých kamer)
            hls on;
            hls_path temp/tmp_hls_individual;
            hls_fragment 2s;
            hls_playlist_length 20m;
            
            # Notify když se kamera připojí/odpojí
            on_publish http://localhost:3000/rtmp/publish;
            on_publish_done http://localhost:3000/rtmp/unpublish;
        }

        # Aplikace pro finální grid (výstup z FFmpeg)
        application grid {
            live on;
            
            # Pouze server může publikovat
            allow publish 127.0.0.1;
            deny publish all;
            
            # HLS adaptive streaming
            hls on;
            hls_path temp/tmp_hls;
            hls_nested on;
            
            # HLS fragments
            hls_fragment 2s;
            hls_playlist_length 60s;
            
            # DVR - umožní divákům jít zpět v čase
            hls_fragment_slicing aligned;
            hls_type live;
            
            # Master playlist
            hls_variant _high BANDWIDTH=4000000,RESOLUTION=1920x1080;
            hls_variant _med BANDWIDTH=2500000,RESOLUTION=1280x720;
            hls_variant _low BANDWIDTH=1000000,RESOLUTION=854x480;
        }

        # Finální output (alternativní název)
        application final {
            live on;
            
            # Push na externí server (pokud chcete)
            # push rtmp://external-server/live/stream;
        }
    }
}

# SSL RTMP (pro zabezpečený transport)
stream {
    upstream rtmp_backend {
        server localhost:1936;
    }
    
    server {
        listen 1935 ssl;
        proxy_pass rtmp_backend;
        
        ssl_certificate ssl/cert.pem;
        ssl_certificate_key ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
    }
}
